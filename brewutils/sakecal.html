<!doctype html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>清酒計算器</title>
    <!-- Bootstrap core CSS -->
    <link href="watercalc/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>

    </style>
</head>

<body>
<div class="container p-3">


<!-- 比重/SMV/波美-->
<div class="rounded container m-3" id="gravity-exchange">
    <div class="row" >
        <div class="col-md"><h3>
            <a class="" data-toggle="collapse" href="#gxdescription" role="button" aria-expanded="false" aria-controls="gxdescription">
                比重/日本酒度/波美互換
            </a></h3></div>
    </div>
    <div class="collapse" id="gxdescription">
        <div class="card card-body">
            三種比重互相換算；比重使用日本酒使用的15&deg;C/4&deg;C。
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-2">比重(15&deg;C/4&deg;C)</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="gx-sg" class="form-control" placeholder="" aria-label="hydrometer reading" aria-describedby="basic-addon2" value="1.0">
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">日本酒度/SMV</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="gx-smv" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">&deg;</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">波美</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="gx-bm" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">&deg;</span>
            </div>
        </div>
    </div>

</div>
<!--  比重/SMV/波美-->



<!-- Temperature calibration-->
<div class="rounded container m-3" id="hydrometer-correction">
    <div class="row" >
        <div class="col-md"><h3>
            <a class="" data-toggle="collapse" href="#hcdescription" role="button" aria-expanded="false" aria-controls="hcdescription">
            比重計溫度修正
            </a></h3></div>
    </div>
    <div class="collapse" id="hcdescription">
        <div class="card card-body">
        日本酒使用的比重是15&deg;C/4&deg;C，意思是在15&deg;C下測量，相對於4&deg;C下水的比重，所以水的日本酒度量起來不是0，而是+1.26， 因為15&deg;C的水密度略小於4&deg;C的水，所以在15&deg;C量起來的對比4&deg;C的比重不是1.0。
        一般啤酒用的比重計通常是20&deg;C/20&deg;C或60&deg;F/60&deg;F（美國產的），要修正成15&deg;C/4&deg;C才能套用這個公式。

         比重計校正溫度通常在刻度最下方有標示。參考：<a href="https://www.homebrewtalk.com/threads/temp-correction-formula-for-hydrometer.10684/post-100698">Temp Correction Formula for Hydrometer, HBT </a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-2">比重計讀數</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="hc-reading" class="form-control" placeholder="" aria-label="hydrometer reading" aria-describedby="basic-addon2" value="1.0">
        </div>
    </div>
    <div class="row">
        <div class="col-md-2">品溫</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="hc-temp" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">&deg;C</span>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="比重計的校正溫度，通常是15或20&deg;C，比重計上會標示。" >校正溫度</div>

        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="hc-ctemp" class="form-control" placeholder="" aria-label="Correction temperature" aria-describedby="basic-addon2" value="20">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">&deg;C</span>
            </div>
        </div>

    </div>
    <div class="row">
        <div class="col-md-2">比重修正值</div>
        <div class="col-md-1 text-right"><span id="hc-corrected-sg"></span></div>
        <div class="col-md-1"></div>
    </div>

    <div class="row">
        <div class="col-md-2">比重(15&deg;C/4&deg;C)</div>
        <div class="col-md-1 text-right"><span id="hc-154-sg"></span></div>
        <div class="col-md-1"></div>
    </div>

    <div class="row">
        <div class="col-md-2">日本酒度SMV</div>
        <div class="col-md-1 text-right"><span id="hc-smv"></span></div>
        <div class="col-md-1"></div>
    </div>

    <div class="row">
        <div class="col-md-2">波美</div>
        <div class="col-md-1 text-right"><span id="hc-bm"></span></div>
        <div class="col-md-1"></div>
    </div>

    
</div>
<!-- Temperature calibration-->




<!-- ABV -->
<div class="rounded container m-3" id="abv-estimation">
    <div class="row" >
        <div class="col-md"><h3>
            <a class="" data-toggle="collapse" href="#abvest" role="button" aria-expanded="false" aria-controls="gxdescription">
                用折射儀和比重計讀數估算ABV
            </a></h3></div>
    </div>
    <div class="collapse" id="abvest">
        <div class="card card-body">
            用折射儀和比重計讀數估算ABV。
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-2">比重/SG</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="abv-sg" class="form-control" placeholder="" aria-label="hydrometer reading" aria-describedby="basic-addon2" value="1.0">
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">折射儀讀數</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="abv-ref" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">&deg;Bx</span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-2">ABV</div>
        <div class="col-md-2 text-right"><span id="abv-abv"></span> %</div>
    </div>

    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="存在100ml酒中的溶解固體重">エキス分</div>
        <div class="col-md-2 text-right"><span id="abv-extract"></span> %</div>
    </div>

    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="存在100ml酒中的己溶解固體重，包括已轉成酒精的部分">原エキス分</div>
        <div class="col-md-2 text-right"><span id="abv-total"></span> %</div>
    </div>
</div>
<!--  ABV-->


<!-- Extract -->
<div class="rounded container m-3" id="extract">
    <div class="row" >
        <div class="col-md"><h3>
            <a class="" data-toggle="collapse" href="#ekisu" role="button" aria-expanded="false" aria-controls="gxdescription">
                エキス分・原エキス分
            </a></h3></div>
    </div>
    <div class="collapse" id="ekisu">
        <div class="card card-body">
            エキス分・原エキス分
        </div>
    </div>


    <div class="row">
        <div class="col-md-2">ABV</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="extract-abv" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">%</span>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-2">日本酒度/SMV</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="extract-smv" class="form-control" placeholder="" aria-label="Nihonshu do" aria-describedby="basic-addon2">
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">比重/SG</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="extract-sg" class="form-control" placeholder="" aria-label="hydrometer reading" aria-describedby="basic-addon2">
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">波美度</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="extract-bm" class="form-control" placeholder="" aria-label="" aria-describedby="basic-addon2">
        </div>
    </div>

    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="存在100ml酒中的溶解固體重">エキス分/Extract</div>
        <div class="col-md-2 text-right"><span id="extract-extract"></span> %</div>
    </div>

    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="存在100ml酒中的己溶解固體重，包括已轉成酒精的部分">原エキス分</div>
        <div class="col-md-2 text-right"><span id="extract-total"></span> %</div>
    </div>

</div>
<!--  Extract-->

<!-- lee/yield -->
<div class="rounded container m-3" id="lee">
    <div class="row" >
        <div class="col-md"><h3>
            <a class="" data-toggle="collapse" href="#leeestimation" role="button" aria-expanded="false" aria-controls="gxdescription">
                酒粕和收酒預估
            </a></h3></div>
    </div>
    <div class="collapse" id="leeestimation">
        <div class="card card-body">
            用原エキス分估算酒粕和收酒量。
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="蒸米的部分">掛米(原料米重)</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="lee-rice" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">kg</span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="用來做麴的米，原料米乾重">麴(原料米重)</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="lee-koji" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">kg</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="仕込的水" >水量</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="lee-water" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">L</span>
            </div>
        </div>
    </div>

    
    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="掛米的吸水率，一般在25-28%，用煮的視加的水量而定，可能會高一些">蒸米吸水率</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="lee-waterAbsorb" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2" value="28">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">%</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="麴米的吸水率，清酒麴一般在13-19%，有的則會高到25%">麴吸水率</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="lee-kojiAbsorb" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2" value="19">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">%</span>
            </div>
        </div>
    </div>

    
    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="Total Extract，可以由ABV和比重算出">原エキス分</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="lee-extract" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">%</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="酒粕中的液體重，50%是一般板榨的值，其他方式可更高">酒粕含水率</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="lee-kasuwater" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2" value="50">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">%</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="上槽後的酒粕重量">酒粕量</div>
        <div class="col-md-2 text-right"><span id="lee-kasu"></span> kg</div>
    </div>
    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="上槽後的得到的原酒重量">原酒量</div>
        <div class="col-md-2 text-right"><span id="lee-sake"></span> kg</div>
    </div>

    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="酒粕除以總米重的比率">粕步合</div>
        <div class="col-md-2 text-right"><span id="lee-kasu-rate"></span> %</div>
    </div>

    <div class="row">
        <div class="col-md-2"   data-toggle="tooltip" data-placement="right" title="米融化溶於酒中的比率，可視為原料利用率">原料利用率</div>
        <div class="col-md-2 text-right"><span id="lee-disolved"></span> %</div>
    </div>

<!--
    <div class="row">
        <div class="col-md-2">總水</div>
        <div class="col-md-2 text-right"><span id="lee-total-water"></span> kg</div>
    </div>
-->
    <div class="row">
        <div class="col-md-2"   data-toggle="tooltip" data-placement="right" title="酒粕中的固體部分">酒粕固體</div>
        <div class="col-md-2 text-right"><span id="lee-kasu-solid"></span> kg</div>
    </div>

    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="酒粕中的液體部分">酒粕液體</div>
        <div class="col-md-2 text-right"><span id="lee-kasu-liquid"></span> kg</div>
    </div>

</div>
<!--  lee/yield-->

<!-- yield from lee -->
<div class="rounded container m-3" id="yield">
    <div class="row" >
        <div class="col-md"><h3>
            <a class="" data-toggle="collapse" href="#yieldestimation" role="button" aria-expanded="false" aria-controls="gxdescription">
            酒粕/粕步合->原エキス分
            </a></h3></div>
    </div>
    <div class="collapse" id="yieldestimation">
        <div class="card card-body">
            用酒粕量/粕步合估算原エキス分。
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="蒸米的部分">掛米(原料米重)</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="yield-rice" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">kg</span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="用來做麴的米，原料米乾重">麴(原料米重)</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="yield-koji" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">kg</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="仕込的水" >水量</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="yield-water" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">L</span>
            </div>
        </div>
    </div>

    
    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="掛米的吸水率，一般在25-28%，用煮的視加的水量而定，可能會高一些">蒸米吸水率</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="yield-waterAbsorb" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2" value="28">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">%</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="麴米的吸水率，清酒麴一般在13-19%，有的則會高到25%">麴吸水率</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="yield-kojiAbsorb" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2" value="19">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">%</span>
            </div>
        </div>
    </div>

    
    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="每公斤米產生的酒粕比率，與酒粕緦量擇一輸入">粕步合</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="yield-kasu-rate" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">%</span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="酒粕總量，與粕步合擇一輸入">酒粕緦量</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="yield-kasu" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">kg</span>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-md-2" data-toggle="tooltip" data-placement="right" title="酒粕中的液體重，50%是一般板榨的值，其他方式可更高">酒粕含水率</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="yield-kasuwater" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2" value="50">
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">%</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2"  data-toggle="tooltip" data-placement="right" title="上槽後的得到的原酒重量">原酒量</div>
        <div class="col-md-2 text-right"><span id="yield-sake"></span> kg</div>
    </div>

    <div class="row">
        <div class="col-md-2"   data-toggle="tooltip" data-placement="right" title="米融化溶於酒中的比率，可視為原料利用率">原料利用率</div>
        <div class="col-md-2 text-right"><span id="yield-disolved"></span> %</div>
    </div>

    <div class="row">
        <div class="col-md-2"   data-toggle="tooltip" data-placement="right" title="總萃取">原エキス分</div>
        <div class="col-md-2 text-right"><span id="yield-extract"></span> %</div>
    </div>

</div>
<!--  yield from lee-->


<!-- amado -->
<div class="rounded container m-3" id="amado">
    <div class="row" >
        <div class="col-md"><h3>
            <a class="" data-toggle="collapse" href="#gxdescription" role="button" aria-expanded="false" aria-controls="gxdescription">
                甘辛度
            </a></h3></div>
    </div>
    <div class="collapse" id="gxdescription">
        <div class="card card-body">
            甘辛度: -3:非常dry, 3:非常甜，0:中庸
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-2">SMV</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="ama-smv" class="form-control" placeholder="" aria-label="hydrometer reading" aria-describedby="basic-addon2">
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">酸度</div>
        <div class="col-md-2 input-group input-group-sm">
            <input type="text" id="ama-sando" class="form-control" placeholder="" aria-label="temperature" aria-describedby="basic-addon2">
        </div>
    </div>
    <div class="row">
        <div class="col-md-2">甘辛度</div>
        <div class="col-md-2 text-right"><span id="ama-ama"></span> <span id="ama-text"></span></div>
    </div>
    <div class="row">
        <div class="col-md-2"><canvas id="amesan" width="557" height="572"></canvas></div>
    </div>    
</div>

<!-- amado -->

</div>   
<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script>
    window.jQuery || document.write('<script src="../../assets/js/vendor/jquery-slim.min.js"><\/script>')
</script>
<script src="water.js"></script>
<script src="amesando.js"></script>
<script src="watercalc/bootstrap/js/bootstrap.bundle.js"></script>
<script>

function waterDensity(t){
    if(isNaN(t)) return NaN;
    if(t<0 || t>100) return NaN;
    return WaterDensityTable[Math.round(t*10)];
}

function C2F(c) { return Math.round((c * 1.8 + 32) * 10) / 10; }

function F2C(f) { return Math.round((f - 32) / 1.8 * 10) / 10; }        

var SakeMath={
    smv2sg:function(smv){
        return 1443 / (1443 + smv);
    },
    sg2smv:function(sg){
        return (1443 - sg * 1443 ) / sg;
    },
    sg2Bm:function(sg){
        if(sg >= 1.0){
            return (1-1/sg) * 144.3;
        }else{
            return (1/sg-1)* 144.3 + 10;
        }
    },
    bm2smv:function(bm){
        return SakeMath.sg2smv(SakeMath.bm2sg(bm));
    },
    bm2sg:function(bm){
        return (bm>=10)?  144/(144-bm):(144/(134+bm));
    },
    abvByRefHyd:function(Bx,sg){
        return 1.646 * Bx - 2.703 * (145 - 145 / sg) - 1.794;
    },
    amado:function(smv,sd){
        return (193593 / (1443 + smv)) - 1.16 * sd - 132.57;
    },
    ekisu:function(sg,abv){
        var abvAsSg=  1.5 * 0.00001 * abv * abv - 0.00149 * abv + 0.9991;
        return (sg - abvAsSg) * 260 + 0.21;
    },
    genekisu:function(sg,abv){
        return SakeMath.ekisu(sg,abv) + abv * 0.7942*2;
    },
    sgTempCorrected: function(Reading, F, CT) {
        return Reading * ((1.00130346 - 0.000134722124 * F + 0.00000204052596 * F * F - 0.00000000232820948 * F * F * F) / (1.00130346 - 0.000134722124 * CT + 0.00000204052596 * CT * CT - 0.00000000232820948 * CT * CT * CT));
    },
    kasucalEx:function(water,rice,riceAbsorb,koji,kojiAbsorb,extract,kasuWater){
        const  K = 0.612;
        const WaterInRice = 0.13;
        var totalRice = rice + koji;
        var totalWater = water + rice * (riceAbsorb + WaterInRice) +  koji *(kojiAbsorb +  WaterInRice);
        var water2rice= totalWater / totalRice;
        var disolved  = extract  * water2rice / ( 1 - extract * K);
        var r={};
        r.kasuSolid= totalRice * ( 1- WaterInRice - disolved);
        r.kasu = r.kasuSolid/(1-kasuWater);

        r.totalLiquid= totalWater + totalRice * K * disolved;   // afer fermenation
        r.sake  = r.totalLiquid - kasuWater * r.kasu;
        r.kasu_rate = r.kasu / totalRice;
        r.disolved = disolved;
        r.totalWater=totalWater;
        return r;
    },
    extractFromKasu:function(water,rice,riceAbsorb,koji,kojiAbsorb,kasu,kasuWater){
        const  K = 0.612;
        const WaterInRice = 0.13;

        var totalRice = rice + koji;
        var totalWater = water + rice * (riceAbsorb + WaterInRice) +  koji *(kojiAbsorb +  WaterInRice);
        var water2rice= totalWater / totalRice;

        var disolvedRate = 1- WaterInRice - kasu * (1-kasuWater)/totalRice;
        var extract = disolvedRate / (water2rice + K * disolvedRate);
        var totalLiquid= totalWater + totalRice * K * disolvedRate; 
        var sake = totalLiquid - kasuWater * kasu;
        return {sake:sake,disolved:disolvedRate,extract:extract};
    }
};

Ekisu={
    //https://www.gitc.pref.nagano.lg.jp/pdf/gijutujoho/No.237(Shokuhin).pdf
    density:[1.0000, 
    .9985,.9970,.9956,.9942,.9929,.9916,.9903,.9891,.9878,.9867,
    .9855,.9844,.9833,.9822,.9812,.9802,.9792,.9782,.9773,.9763,
    .9753,.9742,.9732,.9721,.9711,.9700,.9690,.9679,.9668,.9657,
    .9645,.9633,.9621,.9608,.9594,.9581,.9567,.9553,.9538,.9523,
    .9507,.9491,.9474,.9457,.9440,.9422,.9404,.9386,.9367,.9348,
    .9329,.9309,.9289,.9269,.9248,.9227,.9206,.9185,.9163,.9141,
    .9119,.9096,.9073,.9050,.9027,.9004,.8980,.8956,.8932,.8907,
    .8882,.8857,.8831,.8805,.8779,.8753,.8726,.8699,.8672,.8645,
    .8617,.8589,.8560,.8531,.8502,.8472,.8442,.8411,.8379,.8346,
    .8312,.8278,.8242,.8200,.8168,.8128,.8086,.8042,.7996,.7947
    ],
    ex: function(dal,dsm){
        return (dsm-dal) *260+.21;
    },

    ekisuBun:function(alc,gravity){

        var al= Math.floor(alc); 
        var al1 = al +1;
        var dev = alc - al;
        var dex=Ekisu.ex(Ekisu.density[al1],gravity) - Ekisu.ex(Ekisu.density[al],gravity);

        var exdev=dev*dex+Ekisu.ex(Ekisu.density[al],gravity);

        // roudn exdev
        e=100*exdev+.05; 
        exdev=e/100.0;
    
        return exdev ;
    },
    tex:function(dal,dsm,al){
        var tex=Ekisu.ex(dal,dsm) +1.5894*al;
        return (tex);
    },
    tEkisuBun:function(alc,gravity){
        var al= Math.floor(alc); 
        var al1 = al +1;
        var dev = alc - al;

        var texdev=Ekisu.tex(Ekisu.density[al1],gravity,al+1) - Ekisu.tex(Ekisu.density[al],gravity,al);
        texdev=dev*texdev + Ekisu.tex(Ekisu.density[al],gravity,al); 
        return texdev;
    }
};

$(function() {
    AmeSan.init("amesan",bgImage3);

    $('[data-toggle="tooltip"]').tooltip();

    $("#yield input").change(function(){       
        var rice= parseFloat($("#yield-rice").val());
        var water= parseFloat($("#yield-water").val());
        var waterAbsorb= parseFloat($("#yield-waterAbsorb").val());
        var kasuwater=parseFloat($("#yield-kasuwater").val());
        var koji= parseFloat($("#yield-koji").val());
        var kojiAbsorb= parseFloat($("#yield-kojiAbsorb").val());

        if(isNaN(rice) || isNaN(water) ||isNaN(waterAbsorb) ||isNaN(kasuwater)
           || isNaN(koji) || isNaN(kojiAbsorb)) return;

        var kasuRate=parseFloat($("#yield-kasu-rate").val());
        var kasu =parseFloat($("#yield-kasu").val());

        if($(this).prop("id") == "yield-kasu-rate"){
            kasu = (rice + koji) * kasuRate/100;
            $("#yield-kasu").val(kasu.toFixed(2));
        }else if($(this).prop("id") == "yield-kasu"){
            kasuRate= kasu / (rice + koji) * 100;
            $("#yield-kasu-rate").val(kasuRate.toFixed(1));
        }else{
            if(isNaN(kasuRate) || isNaN(kasu)) return;
        }

        var r=SakeMath.extractFromKasu(water,rice,waterAbsorb/100,koji,kojiAbsorb/100,kasu,kasuwater/100);
        $("#yield-sake").text(r.sake.toFixed(2));

        $("#yield-disolved").text((r.disolved*100).toFixed(1));

        $("#yield-extract").text((r.extract*100).toFixed(1));
    }); 



    $("#lee input").change(function(){       
        var rice= parseFloat($("#lee-rice").val());
        var water= parseFloat($("#lee-water").val());
        var waterAbsorb= parseFloat($("#lee-waterAbsorb").val());
        var extract=parseFloat($("#lee-extract").val());
        var kasuwater=parseFloat($("#lee-kasuwater").val());

        var koji= parseFloat($("#lee-koji").val());
        var kojiAbsorb= parseFloat($("#lee-kojiAbsorb").val());

        if(isNaN(rice) || isNaN(water) ||isNaN(waterAbsorb) ||isNaN(extract) ||isNaN(kasuwater)
           || isNaN(koji) || isNaN(kojiAbsorb)) return;

        var r=SakeMath.kasucalEx(water,rice,waterAbsorb/100,koji,kojiAbsorb/100,extract/100,kasuwater/100);
        $("#lee-kasu").text(r.kasu.toFixed(2));
        $("#lee-sake").text(r.sake.toFixed(2));

        $("#lee-kasu-rate").text((r.kasu_rate * 100).toFixed(1));
        $("#lee-disolved").text((r.disolved*100).toFixed(1));
        $("#lee-kasu-solid").text(r.kasuSolid.toFixed(2));
        $("#lee-kasu-liquid").text((r.kasu - r.kasuSolid).toFixed(2));

        //$("#lee-total-water").text(r.totalWater.toFixed(2));

    }); 

    //Temperature calibration
    $("#hydrometer-correction input").change(function(){                
        var T= parseFloat($("#hc-temp").val());
        var R= parseFloat($("#hc-reading").val());
        var CT=parseFloat($("#hc-ctemp").val());
        var c= SakeMath.sgTempCorrected(R,C2F(T),C2F(CT));
        $("#hc-corrected-sg").text(c.toFixed(5));
        if(!isNaN(CT) && !isNaN(c)){
            var w4c = waterDensity(4);
            var wct = waterDensity(CT);
            
            var sg= c * wct / w4c;
            $("#hc-154-sg").text(sg.toFixed(5));

            var smv = SakeMath.sg2smv(sg);
            var bm = SakeMath.sg2Bm(sg);
            $("#hc-smv").text(smv.toFixed(2));
            $("#hc-bm").text(bm.toFixed(1));

        }
    });


    $("#gravity-exchange input").change(function(){                

        if($(this).prop("id") == "gx-sg"){
            var sg = parseFloat($("#gx-sg").val());
            var smv = SakeMath.sg2smv(sg);
            var bm = SakeMath.sg2Bm(sg);
            $("#gx-smv").val(smv.toFixed(2));
            $("#gx-bm").val(bm.toFixed(1));
        }else if($(this).prop("id") == "gx-smv"){
            var smv = parseFloat($("#gx-smv").val());
            var sg = SakeMath.smv2sg(smv);
            var bm = SakeMath.sg2Bm(sg);
            $("#gx-sg").val(sg.toFixed(4));
            $("#gx-bm").val(bm.toFixed(1));
        }else if($(this).prop("id") == "gx-bm"){
            var bm = parseFloat($("#gx-bm").val());
            var sg = SakeMath.bm2sg(bm);
            var smv = SakeMath.bm2smv(bm);
            $("#gx-sg").val(sg.toFixed(4));
            $("#gx-smv").val(smv.toFixed(2));
        }
    });

    $("#abv-estimation input").change(function(){                
        var sg= parseFloat($("#abv-sg").val());
        var r= parseFloat($("#abv-ref").val());
        if(!isNaN(sg) && !isNaN(r)){
            var abv= SakeMath.abvByRefHyd(r,sg);
            $("#abv-abv").text(abv.toFixed(1));
            var ekisu = Ekisu.ekisuBun(abv,sg);
            var total = Ekisu.tEkisuBun(abv,sg);
            $("#abv-extract").text(ekisu.toFixed(1));
            $("#abv-total").text(total.toFixed(1));
        }
    });

    $("#extract input").change(function(){                
        var sg,smv,bm;
        var abv= parseFloat($("#extract-abv").val());

        if($(this).prop("id") == "extract-sg"){
            sg = parseFloat($("#extract-sg").val());
            smv = SakeMath.sg2smv(sg);
            bm = SakeMath.sg2Bm(sg);
        }else if($(this).prop("id") == "extract-smv"){
            smv = parseFloat($("#extract-smv").val());
            sg = SakeMath.smv2sg(smv);
            bm = SakeMath.sg2Bm(sg);
        }else if($(this).prop("id") == "extract-bm"){
            bm = parseFloat($("#extract-bm").val());
            sg = SakeMath.bm2sg(bm);
            smv = SakeMath.bm2smv(bm);
        }
        $("#extract-sg").val(sg.toFixed(4));
        $("#extract-smv").val(smv.toFixed(1));
        $("#extract-bm").val(bm.toFixed(1));


        if(!isNaN(sg) && !isNaN(abv)){
            var ekisu = Ekisu.ekisuBun(abv,sg);
            var total = Ekisu.tEkisuBun(abv,sg);
            $("#extract-extract").text(ekisu.toFixed(1));
            $("#extract-total").text(total.toFixed(1));
        }
    });

    $("#amado input").change(function(){                
        var smv= parseFloat($("#ama-smv").val());
        var sando= parseFloat($("#ama-sando").val());
        if(!isNaN(smv) && !isNaN(sando)){
            var ama= SakeMath.amado(smv,sando);
            var text=[
                "非常辛口",
                "相當辛口",
                "少許辛口",
                "中庸",
                "少許甘口",
                "相當甘口",
                "非常甘口"
            ];
            var idx =Math.round(ama +3);
            if (idx >6) idx=6;
            if(idx<0) idx=0;
            $("#ama-ama").text(ama.toFixed(1));
            $("#ama-text").text(text[idx]);

            AmeSan.plotOn(smv,sando);
        }
    });


});

</script>

</body>

</html>